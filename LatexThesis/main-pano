% \documentclass[12pt]{report}
\documentclass[11pt,table,xcdraw]{report}

% Fonts
% Greek font
% \usepackage[T1]{fontenc} %% LGR encoding is needed for loading the package gfsneohellenic
% \usepackage[default]{gfsneohellenic}

% Sans serif font
% \usepackage[T1]{fontenc}
% \usepackage{sansmathfonts}
% \renewcommand*\familydefault{\sfdefault} %% Only if the base font of the document is to be sans serif
% \usepackage{lmodern}
% \usepackage{fix-cm}

% TeX Gyre Pagella
\usepackage[T1]{fontenc}
\usepackage{tgpagella}
\usepackage[scaled]{beramono}
% \usepackage{palatino}
% \renewcommand*\familydefault{\sfdefault} %% Only if the base font of the document is to be sans serif
\usepackage{fix-cm}

% Reduce space before chapter title
\usepackage{titlesec}
\titleformat{\chapter}[display]
{\normalfont\huge\bfseries}{\chaptertitlename\ \thechapter}{20pt}{\Huge}
\titlespacing*{\chapter}{0pt}{0pt}{20pt}

% Packages
\usepackage{graphicx}
\usepackage{float}
\usepackage{mathalpha}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{enumitem}
\usepackage{hyperref}
\usepackage{multicol}
\usepackage[super]{nth}
\usepackage{subcaption}
\usepackage[export]{adjustbox}
\usepackage{pdfpages}

% TABLES
\usepackage{xcolor}
\usepackage[normalem]{ulem}
\useunder{\uline}{\ul}{}
\definecolor{llgray}{gray}{0.98}

% Listing in Lisp
\usepackage{listings}
\lstset{
    numbers=left,
    numberstyle=\tiny,
    numbersep=9pt,
    language=Lisp,
    % stringstyle=\ttfamily\small,
    stringstyle=\ttfamily\footnotesize,
    basicstyle=\ttfamily\footnotesize,
    % basicstyle=\ttfamily\scriptsize,
    showstringspaces=false,
    breaklines=true,
    frame=single,
    keywordstyle=\color{purple},
    commentstyle=\color{darkgray},
    backgroundcolor=\color{llgray},
    morekeywords = {gil, om, for, if, setq}
}
% Captions package
\usepackage[hypcap=false]{caption}
\DeclareCaptionType{trans}[Transcription][List of transcriptions]
% Bibliography package
\usepackage[
    backend=biber,
    sorting=none
    % style=authoryear-icomp
]{biblatex}

% Others
\newenvironment{Figure}
  {\par\medskip\noindent\minipage{\linewidth}}
  {\endminipage\par\medskip}

% External files
% \usepackage{xr}
% \externaldocument{Sections/sct_1SP}

% New commands
% TODO counter
\newcounter{todocount}
\newcounter{todosecc}
\newcounter{todoimac}
\setcounter{todocount}{0}
\setcounter{todosecc}{0}
\setcounter{todoimac}{0}
\newcommand{\todo}{\stepcounter{todocount}\textbf{\textcolor{magenta}{TODO \arabic{todocount} }}}
\newcommand{\todosec}{\stepcounter{todosecc}\textbf{\textcolor{blue}{TODO-sec \arabic{todosecc} }}}
\newcommand{\todoimage}{\stepcounter{todoimac}\textbf{\textcolor{red}{TODO-fig \arabic{todoimac} }}}
% shortcut for cantus firmus in italic font
\newcommand{\cf}{\textit{cantus firmus }}
\newcommand{\cfdot}{\textit{cantus firmus. }}
\newcommand{\cfcomma}{\textit{cantus firmus, }}
% shortcut for species
\newcommand{\species}[1]{\nth{#1} species}
% shortcut for B in mathcal
\newcommand{\B}{\mathcal{B}}
% shortcut for N in mathcal
\newcommand{\N}{\mathcal{N}}
% shortcut for R in mathcal
\newcommand{\R}{\mathcal{R}}
% \newcommand{\R}{R}
% shortcut for C in mathcal
\newcommand{\C}{\mathcal{C}}
% shortcut for I in mathcal
\newcommand{\I}{\mathcal{I}}
% shortcut for Lisp ID
\newcommand{\lid}[1]{$\lambda$ID = \texttt{#1}}
% shortcut for default value
\newcommand{\df}[1]{\qquad \textit{DFLT: <#1>}}
\newcommand{\dft}[1]{\textit{DFLT: <#1>}}
\newcommand{\dfts}[1]{\textit{<#1>}}
% shortcut for forall values
\newcommand{\forj}{\forall j \in [0, m-1)}
\newcommand{\forn}{\forall i \in \B, \forall j \in [0, m)}
\newcommand{\fornm}{\forall i \in \B, \forall j \in [0, m-1)}
\newcommand{\fornmm}{\forall i \in \B, \forall j \in [0, m-2)}
\newcommand{\forp}{\forall \rho \in positions(m)}
\newcommand{\forpm}{\forall \rho \in positions(m-1)}
\newcommand{\forpmm}{\forall \rho \in positions(m-2)}
% size used for the height of figures
\newcommand{\fhs}{1.1in}
\newcommand{\fh}{1.2in}
\newcommand{\fhl}{1.3in}

% auto cite from bib
\DeclareCiteCommand{\citea}
{\boolfalse{citetracker}\boolfalse{pagetracker}\usebibmacro{prenote}}
{\href{\thefield{url}}{here}}
{\multicitedelim}
{\usebibmacro{postnote}}
% add "Score available here." sending to url + reference beside
\newcommand{\listen}[1]{Score available \citea{#1} \parencite{#1}}
% add "Listen here." sending to url + reference beside
\newcommand{\listenyt}[1]{and listen \href{#1}{here} \parencite{EvalYT}.}



\newcommand{\reddot}{\textcolor{red}{\textbullet} }



% Load Bibliography
\addbibresource{Bibliography/cite.bib}

\title{Formalizing Fux's Theory of Musical Counterpoint Using Constraint Programming}
\author{Thibault Wafflard}
\date{June 2023}

% Document settings
% \usepackage[margin=1.3in]{geometry}
\usepackage{geometry}
\geometry{
    a4paper,
    % total={170mm,257mm},
    left=1.3in,
    right=1.3in,
    top=1in,
    bottom=1in,
}

\title{MÃ©moire}
\author{Anton Lamotte}
\date{November 2023}

\begin{document}
% \pagenumbering{roman}
% \maketitle
%\includepdf[pages=1]{FrontPage.pdf}
%\null
%\thispagestyle{empty}
%\addtocounter{page}{-1}
%\newpage
%\newgeometry{left=1.65in,right=1.65in,top=2in,bottom=2in}

%\begin{abstract}
%    \large{
%        This master's thesis presents FuxCP, a tool for computer-aided contrapuntal composition. The objective is to assist composers without programming skills by automating repetitive and time-consuming tasks. The tool is based on constraint programming with Gecode and formalizes musical rules as constraints. Thanks to this approach, the tool provides transparency and control over the generated solutions, allowing composers to shape their desired music. This thesis focuses on formalizing the rules of two-voice counterpoint from Fux's \textit{Gradus ad Parnassum}. The research highlights the advantages of constraint programming over other approaches, as it allows the tool to "understand" the generated music. The thesis covers the formalization of counterpoint species-specific rules as mathematical constraints, the evaluation of the tool compared to Fux, and suggestions for future development. The conclusion emphasizes the importance of a comprehensive set of rules for formalization, the need for additional constraints on melodic development, and the potential for more expert solvers in other musical genres. The findings indicate the potential of constraint programming in enhancing computer-aided composition across various musical styles.
%    }
%\end{abstract}


%\maketitle
\chapter{Introduction}

\subsection{Some notations}

E2.2W means "Equation 2.2 from T. Wafflard's thesis".

S1.3W means "Section 1.3 from T. Wafflard's thesis".

\chapter{Defining some concepts and redifining the variables} \label{section:bass}
Before we start this section, we need to look at some vocabulary to make sure we understand what we are discussing. Here we will define the terms "parts" and "registers". In an n-voice composition, there are n registers and n parts. The parts correspond to what a given individual sings, in other words, each part corresponds to a staff. This is the same term that Fux uses in his work. The \textit{cantus firmus}, like each of the counterpoints, are parts.
As for the registers, these are each of the melodic lines, starting from the lowest to the highest. The lowest register always consists of the lowest notes of all the parts. This term has been chosen because it is close to its original meaning, which is that in music the term "register" refers to the entire pitch range covered by a musical composition, encompassing the low, middle and high frequencies of the audible spectrum. 
We will use these terms where the distinction between the concepts is important; where it is not, we will also use the generic term 'voice'.
Since a picture is worth a thousand words, Figure \ref{fig:lowest} illustrates the difference between parts (the blue lines) and registers (the red and orange lines). The lowest register is shown in its own colour (red) because it will be particularly important later on.

\begin{figure}[ht]
  \centering
  \includegraphics[width=1\textwidth]{images/lowest.png}
  \caption{Parts and registers in a three voice composition}
  \label{fig:lowest}
\end{figure}

Here is also the mathematical representation of the lowest register (written $N^{\lambda}$, see section \ref{section:changes induced} for the notations):
\begin{equation}
    \forall j \in [0, m-1) : N^{\lambda}[0,j] = min(N^{cp_1}[0,j], N^{cp_1}[0,j], N^{cp_1}[0,j])
\end{equation}

Of the first upper register, or medium register (written $N^{u_1}$):
\begin{equation}
    \forall j \in [0, m-1) : N^{u_1}[0,j] = med(N^{cp_1}[0,j], N^{cp_1}[0,j], N^{cp_1}[0,j])
\end{equation}

And of the second upper register, or uppest register (written $N^{u_2}$):
\begin{equation}
    \forall j \in [0, m-1) : N^{u_2}[0,j] = max(N^{cp_1}[0,j], N^{cp_1}[0,j], N^{cp_1}[0,j])
\end{equation}

One of the major differences between the implementation of two-voice counterpoint (i.e., one \textit{cantus firmus} and one counterpoint) and the generalisation to three voices (i.e., one \textit{cantus firmus} and two counterpoints) is that the rules no longer necessarily apply between the counterpoints and the \textit{cantus firmus}. If we go back to the rules for two voices, we see that each of them applied between the single counterpoint and the \textit{cantus firmus}. For example, when it was stated that each interval must be consonant, this referred to the interval between the counterpoint and the \textit{cantus firmus}.
On the other hand, in his second part (where he describes the rules for composing in three voices), Fux explains that the rules are not necessarily to be observed between each of the counterpoints and the \textit{cantus firmus}, but rather between each of the voices and the lowest voice. Again, if we take the example of the need for consonance between the voices, consonance will be required in the intervals between the notes of a voice and those of the bass (whether or not the latter is the \textit{cantus firmus}).
Fux also points out that the lowest voice can change, and that at any given moment the lowest voice should be considered. In other words, Fux says that the rules apply between the parts and the lowest register.
This may seem trivial, but it's a huge paradigm shift, because the relationships are no longer considered in the same way! The \textit{cantus firmus} loses some of its pride of place and cedes much of it to the lowest register.
In fact, it's only a change in appearance. From the beginning, when there were only two voices, the rules applied between each voice and the lowest register. Now, when there is only one counterpoint and one \textit{cantus firmus}, the lower register will always be equal to one and the other will be the bass, and when the rules are applied between the single counterpoint and the \textit{cantus firmus}, the rules are necessarily applied 'equally' between the upper voice and the lower voice. Two-part counterpoint was therefore a special case of a more general rule, which it nevertheless follows!

It is, of course, possible for the \textit{cantus firmus} to be the lower voice, in which case nothing changes in the way the problem is perceived. It's when it ends up higher than one of the counterpoints that this consideration becomes important.

A very important detail about this and maybe the biggest change brought about by this paradigm shift is that the \textit{cantus firmus} now becomes a counterpoint like any other, with the difference that its notes are already fixed. This means that we are going to treat the \textit{cantus firmus} as a first species counterpoint (since it is always constituted by only whole notes), and that we will need to calculate its intervals, movements and costs, as we have already been doing it with 'normal' counterpoints.

\section{Changes induced in the variables} \label{section:changes induced}

Many changes have been induced as a result of the three part generalisation. In two part composition, it was obvious that the harmonic intervals array was describing the intervals between the \textit{cantus firmus} and the only counterpoint, it was obvious that the motions were those of the only counterpoint, and so it goes for all the variables. When writing a three part composition, we are dealing with many possibilities when speaking about "intervals" or motions. Intervals between which voices? Motions of which counterpoint? To tackle this, each variable is now related to a voice.

When written in the exponent of a variable, $cf$ means that the variable is related to the \textit{cantus firmus}. $cp_1$ means that the variable is about the first counterpoint and $cp_2$ means that the variable is about the second one.

When a variable is about the lowest register, its exponent is \textit{$\lambda$} (this notation was chosen because it is much easier to read than a simple \textit{l}). The top voices are denoted \textit{u$_1$} and \textit{u$_2$} (for "\textit{u}pper").

The notation H$^{cp_1}$, for example, corresponds to the variable representing the harmonic intervals of the first counterpoint, whereas H$^{cf}$ are the harmonic intervals of the bass (see section \ref{subsection:modified_variables} what this actually means).

This change applies to all variables (i.e. N (formerly cp), H, M, P, IsCfB and IsCons:  and to all costs (section 2.2.2 of T. Wafflard's thesis) with the exception of $\mathcal{C}$ (the cost factors) and $\tau$ (the total cost).

\subsection{Added variables}
\vspace{.5cm} \noindent \textbf{$\Lambda$} \hspace{.cm} \texttt{is-bass} \label{is-bass}

This boolean array of size $m$ reifies if the considered part is the lowest one. Its notation was chosen as it is the uppercase of $\lambda$ (the lowest register). It only takes into consideration the first note of every measure. The reason for this is that when all the rules were given according to the \textit{cantus firmus}, they were always based on the first beat of each measure (which is logical, as the \textit{cantus firmus} has no notes on the other beats. Given that the rules should work exactly the same way, they are only considering the first beat of the lowest record.
It is also worth to be noted that only one of the parts can be the lowest record at the time. This does not mean that two parts cannot equal the lowest record at the same time, they can. It means that only one of those two is going to be considered to \textit{be} the lowest record (and the other one will be the middle record). This is needed in order for motions to work well (both the motions costs and the constraint not to get to a direct consonance by direct motion).

Here is the mathematical definition of this array:
\begin{equation}
\begin{aligned}
&\forall j \in [0, m-1) \colon  \\
\Lambda^{cf}[j] &:= (N^{cf}[0,j] = N^\lambda[0,j])\\
\Lambda^{cp_1}[j] &:= ((N^{cp_1}[0,j] = N^\lambda[0,j]) \land \neg \Lambda^{cf}[j])\\
\Lambda^{cp_2}[j] &:= (\neg \Lambda^{cf} \land \neg \Lambda^{cp_1})
\end{aligned}
\end{equation}

In practice, there is only a \texttt{is-not-bass} array in the code (which is then equal to $\neg \Lambda$), as it is almost always more useful to know if a part is \textit{not} the lowest record than knowing if it is the lowest one. 


\subsection{Modified variables} \label{subsection:modified_variables}
Given that the majority of the rules now apply between parts and the lowest register, the meaning of the variables has been modified to adapt to this reality. 

\vspace{.5cm} \noindent \textbf{N} \hspace{.2cm} \texttt{notes} 

We changed the name of former \texttt{cp} array and renamed it to \texttt{N} (for notes), for the sake of clarity. As we have now three of those arrays (one for the first counterpoint, one for the second counterpoint, and even one for the \textit{cantus firmus}), it needed a less ambiguous name than the one it had before.


\vspace{.5cm} \noindent \textbf{H}$_{(abs)}^{v_1-v_2}$ \hspace{.2cm} \texttt{h-intervals}\hspace{.2cm} \texttt{h-intervals-abs}\hspace{.2cm} \texttt{h-intervals-to-cf}\hspace{.2cm} \texttt{h-intervals-cp1-to-cp2}

The way in which this variable works remains much the same, i.e. it represents the interval between one voice and another. This definition has been extended to include intervals other than that between the counterpoint and the \textit{cantus firmus}. Thus, H$^{v1-v2}$ represents the intervals between the $i$th beat of voice $v_1$ and the \textit{first} beat of voice $v_2$. By default, H$^{v_1}$ represents the intervals between the voice $v_1$ and the lowest register, so $H^{v_1} := H^{v_1-\lambda}$.

Here is a generalisation of the previous rule, matching to the current definition of the H array:
\begin{equation}
    \begin{gathered}
        \forall i \in \mathcal{B}, \quad \forall j \in [0, m):\\
        H_{abs}^{v_1-v_2}[i, j] = \left|N^{v_1}[i, j] - N^{v_2}[0,j]\right|\\
        H^{v_1-v_2}[i, j] = H_{abs}[i, j]\ \text{mod}\ 12\\
        \text{where } H_{abs}[i, j] \in [0, 127], H[i, j] \in [0, 11]
    \end{gathered}
\end{equation}


\vspace{.5cm}
\noindent \textbf{P} \hspace*{.2cm} \texttt{motions}

Motions are now calculated according to the movements of the lowest register. The problem here is that if a part is also the lowest register, we end up calculating the motion between a part and itself. This inevitably leads to direct motions being calculated, because a part is always moving in the same direction as itself. To solve this problem, the motions of a part are now equal to -1 when the part is also the lowest record (denoted $\Lambda$, see section \ref{is-bass}). 
\begin{equation}
\begin{aligned}
&\forall v \in \{cf, cp_1, cp_2\}, \quad \forall x \in \{1, 2\}, \quad \forall i \in B, \quad \forall j \in [0, m - 1),\quad x := b - i\\
    P^{v}[i,j]& = \,  
    \begin{cases}
        -1 & \text{if } \Lambda^{v} \\
        0 & \text{if } \neg \Lambda^{v} \land ((M_{brut}^{x, v}[i, j] > 0 > M^{\lambda}_{brut}[j]) \vee\, (M_{brut}^{x, v}[i, j] < 0 < M^{\lambda}_{brut}[j])) \\
        1 & \text{if } \neg \Lambda^{v} \land (M_{brut}^{x, v}[i, j] = 0  \oplus M^{\lambda}_{brut}[j]=0) \\
        2 & \text{if } \neg \Lambda^{v} \land ((M_{brut}^{x, v}[i, j] > 0 \land M^{\lambda}_{brut}[j] > 0) \vee\, (M_{brut}^{x, v}[i, j] < 0 \land M^{\lambda}_{brut}[j] <0))
    \end{cases}
\end{aligned}
\end{equation}


\chapter{Formalizing Fux rules into English}
This section will be all about extracting all the rules Fux mentions in his work and making sure they are unambiguous.
It will consist of six subsections: one for each species plus one for all species, because even though Fux doesn't clearly mentions rules for all species, some of his rules for the first species are more than certainly meant to be observed for all of them. 

\section{First species}
All rules described in this subsection marked with a red dot (\reddot) apply not only to the first species but to all of them. When described in this section applies to all species, it means that it applies to the first beat of every species, unless mentioned otherwise, and excepted for the fourth species, where it applies to the the beat.

\subsection{This species consists of three whole notes in each instance (p.71)}
This pretty straightforward rule is the very definition of the firsts species. It adds nothing in comparison with the rules for the two part comparison. It is hence already implemented by the first species for two voices and does not need any consideration. 

\subsection{\reddot This species consists of three notes, the upper two being consonant with the lowest (p.71)} \label{rule:consonant}
This rule is a new one, and it implicitly overrides the rule 1.H1 (from T. Wafflard) saying that \textit{all} intervals must be consonants. Here Fux states that only the upper voices and the lowest one are.

This rule was already enforced in the two parts composition, but as discussed in section \ref{section:bass}, the big change here is that Fux mentions that it should not be applied between the counterpoints and the \textit{cantus firmus}, but between the voices and the lowest one. Therefore, we are changing the constraint %todo write nb of constraint
a little bit to adapt to this new rule:

\subsection {\reddot The harmonic triad should be employed in every measure if there is no special reason against it (p.71)}
As the footnote on page 71 states it, Fux refers to the "harmonic triad" as being a chord in this position: 1-3-5 (contrary to what is today understood as a harmonic triad).
The rule says it is not obligated, but it is preferred, to use the 1-3-5 chord, considering that 1 is the lowest voice. As this is a preference and not an absolute rule, it has been implemented as a cost. If harmonic triad is used, then the cost is 0. Else, it is 1.
% todo should not be 1 absolutely, should depend on the user
\begin{equation}
\begin{aligned}
\forall j \in [0, m-1) \colon &\\
(\neg (H_{u_1}[0, j] = 3 \lor H_{u_1}[0, j] = 4) &\lor \neg (H_{u_2}[0, j] = 7)) \\
\iff cost_{prefer-harmonic-triad}&[j] = 1
\end{aligned}
\end{equation}

This rule is considered to be true also for the other species.

\subsection{\reddot Occasionally, one uses a consonance not properly belonging to the triad, namely, a sixth or an octave (p.72)}
Here, Fux explains that when it is not possible to have a harmonic triad, you can use sixths or octaves instead. Remember that the sixths or the octaves are calculated from the lowest register. Since the rule \ref{rule:consonant} obligates the use of a perfect consonance (i.e. a third, a fifth, a sixth or an octave), when the harmonic triad cannot be used, it is already naturally replaced by a third or a sixth, because no other intervals are allowed. It is thus not a new rule but a restatement of rule \ref{rule:consonant}.

\subsection{\reddot The necessity of avoiding  the succession of two perfect consonances [...] (p.72)} \label{rule:succ-p-cons}
Fux here implies that there should be no two successive perfect consonances. He does not specify whether this rule applies to all three parts at once (i.e. if there was a consonance at bar X between part 1 and part 2, there cannot be one between part 2 and 3 at bar X+1), or whether it applies to each pair of parts separately. That said, in his example (Fig. 91 of the English version), we can clearly see that there is perfect consonance in every bar (parts 1-3, then 1-2, then 1-3, then 2-3, then 1-2). From this we can deduce that for each pair of parts it is forbidden for two perfect consonances to follow each other.

\begin{equation} \begin{aligned}
\forall v_1, v_2 \in \{cf, cp_1, cp_2\}, \quad v_1 \neq v_2 \quad \\
\forall j \in [0, m-2) \colon H^{v_1-v_2}[0, j] \in Cons_p \\
\implies H^{v_1-v_2}[0, j+1] \notin Cons_p
\end{aligned} \end{equation}

Which means a harmonic interval and the following one cannot be consonant at the same time.

\textbf{N.B.} This being said, Fux doesn't seem to follow this rule strictly. Maybe it should be converted as a cost.

\subsection{\reddot [Each part] follows the natural order closely (p.73)}
As this is not really clear, Fux later complements his explication by saying the counterpoints should be "moving gracefully, stepwise without any skip". This is clearly a preference, and has already been covered when implementing the first species for two voices. It can thus be ignored in the scope of this thesis.

\subsection{\reddot [Each part] follows the principle of variety (p.73)}
Fux never defines clearly what he means by "principle of variety". Nevertheless, the examples he provides are of a great help as he corrects his student not following the principle, by augmenting the variety of different notes in a single voice. This means, the principle of variety can be understood as having as many different notes in a single voice. As it is not explained either if this has to be true for the whole partition or only for two following notes, it has been chosen as an arbitrary split in two of the debate to use the principle of variety over 4 following notes. This means that the solution is penalized if a note in measure X was already present in measures [X-3, X+3].

\begin{equation} \begin{aligned}
\forall cp \in \{cp_1, cp_2\}, \quad \forall j \in [0, m-1), \quad \forall k \in [j+1, min(j+3, m-1)] :\\ cp[0, j] = cp[0, j+k]\iff cost_{diversity}[j+m*k]= 1
\end{aligned} \end{equation}

\subsection{\reddot To allow enough space for the voices to move toward each other by contrary motion, the upper voices begin distant from the bass (p.75)}
This is not a strict rule but an indication to make easier for the composer to have contrary motions. It is not an obligation, nor a preference, so it was simply added as a heuristic for the solver.

\subsection{\reddot All voices ascend[ing] [is] a progression which can hardly be managed without awkwardness resulting (p.76)}
What Fux says here is that the three parts cannot be moving in the same direction. 
To prohibit this, we just have to look at the motions between the parts and the bass. If one of their motion is contrary, then it is ensured that the three voices are not going in the same direction (as at least one is contrary). Same goes if one motion is oblique. The problem occurs if both motions are direct, as it would mean that the three voices are going in the same direction. So, we have a prohibit this, by constraining that the two motions can't be direct at the same time. 
\begin{equation} \begin{aligned}
 \forall j \in [0, m-2) \colon \neg (M_{cp_1}[0, j] = 2) \lor \neg (M_{cp_2}[0, j] = 2)
\end{aligned} \end{equation}

\subsection{\reddot [Your may reach] a perfect consonance by direct motion [if] there is no other possibility (p.77)}
This is a relaxation of the 1st species for two voices constraint saying that you cannot reach a perfect consonance by direct motion. Because it is sometimes mandatory with three voices to break this rule (as there are no other possibilities), you may derogate from this rule. Since there is no way in constraint programming to implement a rule that must not be obeyed only if possible other 
than by using a cost, the initial constraint (1.P1-W)  was rewritten to use one :

\begin{equation} \begin{aligned}
\forall v \in \{cp_1, cp_2\}, \quad \forall j \in [0, m-1) : H^{v}[0, j+1] \in Cons_{p} \land P^{v}[0, j] = 2 \\
\iff \text{{Cost}}_{\text{{direct\_move\_to\_p\_cons}}}[j] = 8
\end{aligned} \end{equation}

\subsection{\reddot One feels that the degree of perfection and repose which is required of the final chord does not become sufficiently positive with this imperfect consonance [(speaking about a tenth)] (p.77)}
When Fux says this, he takes a tenth as an example, but it here understood that the final chord cannot include a tenth (third + octave), nor an eight-teenth (third + two octaves), etc. Third are accepted though. The rule then becomes: 

\begin{equation} \begin{aligned}
&\forall v \in \{u_1, u_2\} \quad \\
&\forall h \in \{4 + (12 \times k) \mid k \in \mathbb{N} \setminus \{1\}\} \colon \\
&H_{brut}^{v}[0, m-1] \neq h
\end{aligned} \end{equation}


\subsection{\reddot Ascending sixths on the downbeat sound harsh (p.77)}
This rule is pretty straightforward and states that if an interval is a sixth, the next one cannot be one.
\begin{equation} \begin{aligned}
&\forall j \in [0, m-2)   \quad \forall v_1 \in \{cf, cp_1, cp_2\} \quad \forall v_2 \in \{cf, cp_1, cp_2\} \quad (v_1 \neq v_2) \colon\\
&\neg (H^{v_1-v_2}[0, j] \in \{8, 9\} ) \lor \neg (H^{v_1-v_2}[0, j+1] \in \{8, 9\})\\
&\lor \neg (v_1[0,j] < v_1[0,j+1]) \lor \neg (v_2[0,j] < v_2[0,j+1]))
\end{aligned} \end{equation}


\subsection{\reddot Unison is less harmonious than the octave (p.79)}
This rule is already covered by the no-unison constraint in the first species for two voices.

\subsection{\reddot One should not exceed the limits of the five lines without grave necessity (p.79)}
This rule is already covered by the melodic costs in first species for two voices.

\subsection{\reddot Skip of a major sixth is prohibited (p.79)}
Fux then explains that not only are the skips of a major sixth prohibited, but all bigger skips. This rule is already covered by the constraints of the first species for two voices. 

\subsection{\reddot The minor third is not capable of giving a sense of conclusion (p.80)}
Actually, Fux later states that minor modes should not include a third altogether, but that sometimes it is impossible to do without it, so you can use major third in a minor mode.
\begin{equation} \begin{aligned}
\forall v \in \{u_1, u_2\} \colon H^{v}[0, m-1] \neq 3
\end{aligned} \end{equation}


\section{Implicit rules}
\subsection{\reddot First and last notes have not to be perfect consonances anymore} \label{rule:last-chord-not-perfect-anymore}
Fux doesn't state this in his text, but in many of his examples, we see that now we have 3 voices, not all voices must be perfect consonances to the first one in the first and last measure.

\subsection{\reddot Last note must be composed of the notes of the a harmonic triad} \label{rule:last-chord-h-triad}
Again, this isn't stated explicitly but we see that all of his examples end with a chord containing exclusively the notes of the harmonic triad.

\begin{equation} \begin{aligned}
\forall v \in \{u_1, u_2\} \colon H^{v}[0, m-1] \in \{0, 3, 4, 7\}
\end{aligned} \end{equation}


\subsection{\reddot The last chord must have the same fundamental as the one of the scale used throughout the composition}
This rule emanates from an observation of Fux's examples throughout the chapter. He always ends his examples with the same fundamental as the on of the scale.
When the \textit{cantus firmus} is the lowest register, this is not a problem, as the \textit{cantus firmi} always end with the fundamental note of the scale. But when not, it has to be imposed by a constraint, or we may end up with surprising results. Since the fundamental of the scale is defined by being the first note of the \textit{cantus firmus}, we impose that the last note of the lowest register must be equal to the first one of the \textit{cantus firmus} (taking the modulos into account).


\begin{equation} \begin{aligned}
\lambda[0, m-1] \mod 12 = N^{cf}[0, 0] \mod 12
\end{aligned} \end{equation}



\section{Second species}
\subsection{A half note may, for the sake of the harmonic triad, occasionally make a succession of two parallel fifth acceptable - which can be effected by the skip of a third (p.86)}
Fux didn't speak about prohibiting two parallel (i.e. consecutive) fifths in the second species for two voices. That being said, it is indeed prohibited in three parts composition as you cannot have two successive perfect consonances (see constraint \ref{rule:succ-p-cons}. We thus have to relax this constraint in order to accept two successive consonances, when the two successive fifths flank a third.


\subsection{Ligatures have no place in this species [except] in the final cadence (p.87)}
Fux explains that in some cases, you have no other option than ligaturing the fourth-to-last and the third-to-last notes. The reasons he gives for this are all part of the previous mentioned rules (no successive perfect consonances, no unison, ...).
This is a relaxation of the two-voice constraint and is done quite easily by modifying the constraint that says "no consecutive notes cannot be the same" unisson between two consecutive notes" to except cp[2, m-1] and cp[0, m]. The reason why this has not been implemented as a cost but as a constraint relaxation is because Fux seems not to say that there is any counterpart at ligaturing the fourt-to-last and the third-to-last notes.

\subsection{A major third [may] appear in the last chord. (p.87)}
This is a consequence of now using three voices instead of two. Fux just made explicit here a rule we had already defined (\ref{rule:last-chord-not-perfect-anymore} and \ref{rule:last-chord-h-triad}). It has thus already been implemented in the first species for two voices.

\subsection{The half notes are always concordant with the two whole notes (p.88)}
If Fux meant "consonant" when he wrote "concordant", then this rule is pretty straightforward. The concern here is that he doesn't seem to follow his own rule. Anyway, here is the mathematical notation for this rule:
\begin{equation} \begin{aligned}
    &\forall v_1 \in \{cp_1, cp_2, cf\} \quad \forall v_1 \in \{cp_1, cp_2, cf\}, v_1 \neq v_2 \colon\\
    &species^{v_1} = 2 \iff H^{v_1-v_2} \in Cons
\end{aligned} \end{equation}

\section{Third species}
\subsection{The quarters have to concur with the whole notes of the other voices (p.91)}
When using the word "concur", it is plausible that Fux meant "are put in relation", and not "be consonant", as he said that the quarters \textit{concur} with the \textit{cantus firmus} in two voices composition. It is not a rule \textit{per se}, Fux is only annunciating that some rules are going to be introduced.

\subsection{Take care whenever you cannot use the harmonic triad on the first quarter occurring on the upbeat, to use it on the second or third quarters (p.91)}
This rule is clear, and states that we should use the harmonic triad in the second or third beat when we were not able to use it in the first one. This is not an absolute rule, but either an advice, and thus it was treated as a cost.


\subsection{A whole note may occasionally be used in the next to last measure (p.93)}
This rule about the second species is written in a footnote and it seems to apply not only to when the second species is used in combination to the third species, but also in other cases. (fig. 134, 173 and 174 of the English version)

\section{Fourth species}
\subsection{The ligature is nothing but a delaying of the note following (p.95)}
In other words, $cp[n]$ should be associated to $cf[n-1]$ when performing calculations. This is already made by the computations of the two voices counterpoints. It is nevertheless useful to be well aware of this fact, since it will induce many special cases in the implementation.
\subsection{Succession of several fifths was prohibited in species $<$~4}
Fux gives an incorrect example of several fifths following themselves in first species and says it is incorrect. Indeed, it implies following perfect consonances. However, he says this is allowed in the fourth species.
%todo wtf?
\subsection{The fifth is a perfect consonance, the octave a more perfect one, and the unison the most perfect of all; and the more perfect a consonance, the less harmony it has (p.97)}
This is almost covered by the existing costs, as a perfect consonance has a cost of 1, where an imperfect consonance has a cost of 0. This precision in the rule (fifth is better than octave) could be solver by either putting a cost of 2 to octaves and a cost of 1 to fifths, or to put the cost for fifth before the cost for octaves in the lexicographical array of costs.
\subsection{A dissonance that resolves to a fifth is more acceptable than a dissonance that resolves to an octave (p.98)}
This is be covered by the previous cost, as the fifth is preferred to the octave.

\subsection{If I said that the first note of the ligature must always be consonant, that applies only to the instances in which the bass remains on a pedal point, that is, in the same position. In such a case a ligature involving only dissonances is not only correct but even very beautiful (p.98)}
The rule evoked here is changing a previous rule about consonance (4.H1W)

\subsection{The seventh must be set with the third}
I don't understand this one.

\subsection{The tenor (and even the alto or the soprano) may take the place of the bass}
This had already been evocated in first species, but still has to be implemented.

\subsection{To avoid hidden fifths, we may leave the first note of the second counterpoint void.}
I am not sure to have understood the hidden fifths : WIP.

\section{Fifth species}
No supplementary rules have been observed by Fux. However, it might be interesting to add some constraints on the rythm in order to avoid the same rythms when using two fifth species counterpoints. (as discussed on 23th November).
\end{document}
